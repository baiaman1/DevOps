# Part 1. Инструмент **ipcalc**
`-` **ipcalc** — это утилита, которая может выполнять простые манипуляции с адресами IPv4.
Если вы просто наберете **ipcalc** без каких-либо параметров ввода, это даст вам хороший вывод «справки» с некоторыми примерами, которые очень полезны для начала работы.

**== Задание ==**

#### Поднять виртуальную машину (далее -- ws1)

#### 1.1. Сети и маски
#### Определить и записать в отчёт:
#### 1) Адрес сети *192.167.38.54/13*
```ipcalc 192.167.38.54/13```
![ipcalc](/src/imgs/part1/ipcalc1.png)
#### 2) Перевод маски *255.255.255.0* в префиксную и двоичную запись, */15* в обычную и двоичную, *11111111.11111111.11111111.11110000* в обычную и префиксную
#### *255.255.255.0* в префиксную и двоичную
```ipcalc 192.167.38.54 255.255.255.0```
![ipcalc](/src/imgs/part1/ipcalc2.png)

#### */15* в обычную и двоичную
```ipcalc 192.167.38.54/15```
![ipcalc](/src/imgs/part1/ipcalc2.2.png)

#### *11111111.11111111.11111111.11110000* в обычную и префиксную
#### К сожалению, мы не можете указать двоичную форму адреса в качестве ввода ipcalc.
```ipcalc 192.167.38.54/28```
![ipcalc](/src/imgs/part1/ipcalc2.3.png)

#### 3) Минимальный и максимальный хост в сети *12.167.38.4* при масках: */8*, *11111111.11111111.00000000.00000000*, *255.255.254.0* и */4*
#### При маске */8*:
```ipcalc 12.167.38.4/8```
![ipcalc](/src/imgs/part1/ipcalc3.1.png)
#### При маске *11111111.11111111.00000000.00000000*:
```ipcalc 12.167.38.4/16```
![ipcalc](/src/imgs/part1/ipcalc3.2.png)
#### При маске *255.255.254.0*:
```ipcalc 12.167.38.4 255.255.254.0```
![ipcalc](/src/imgs/part1/ipcalc3.3.png)
#### При маске */4*:
```ipcalc 12.167.38.4/4```
![ipcalc](/src/imgs/part1/ipcalc3.4.png)

#### 1.2. localhost
#### Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: *194.34.23.100*, *127.0.0.2*, *127.1.0.1*, *128.0.0.1*
#### Диапазон петлевых адресов представляет собой весь 8-битный диапазон класса A. 
#### 127.0.0.0 — 127.255.255.255 (Зарезервировано для петлевых интерфейсов (не используется для связи между узлами сети), так называемый localhost). Соответсвенно адресами с меткой *Loopback* можно обратиться.

#### *194.34.23.100*
```ipcalc 194.34.23.100```
![ipcalc](/src/imgs/part1/localhost1.1.png)

#### *127.0.0.2*
```ipcalc 127.0.0.2```
![ipcalc](/src/imgs/part1/localhost1.2.png)

#### *127.1.0.1*
```ipcalc 127.1.0.1```
![ipcalc](/src/imgs/part1/localhost1.3.png)

#### *128.0.0.1*
```ipcalc 128.0.0.1```
![ipcalc](/src/imgs/part1/localhost1.4.png)

#### 1.3. Диапазоны и сегменты сетей
#### Определить и записать в отчёт:
#### 1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: *10.0.0.45*, *134.43.0.2*, *192.168.4.2*, *172.20.250.4*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *172.16.255.255*, *10.10.10.10*, *192.169.168.1*

```ipcalc 10.0.0.45```
![ipcalc](/src/imgs/part1/ipPub1.png)

```ipcalc 134.43.0.2```
![ipcalc](/src/imgs/part1/ipPub2.png)

```ipcalc 192.168.4.2```
![ipcalc](/src/imgs/part1/ipPub3.png)

```ipcalc 172.20.250.4```
![ipcalc](/src/imgs/part1/ipPub4.png)

```ipcalc 172.0.2.1```
![ipcalc](/src/imgs/part1/ipPub5.png)

```ipcalc 192.172.0.1```
![ipcalc](/src/imgs/part1/ipPub6.png)

```ipcalc 172.68.0.2```
![ipcalc](/src/imgs/part1/ipPub7.png)

```ipcalc 172.16.255.255```
![ipcalc](/src/imgs/part1/ipPub8.png)

```ipcalc 10.10.10.10```
![ipcalc](/src/imgs/part1/ipPub9.png)

```ipcalc 192.169.168.1```
![ipcalc](/src/imgs/part1/ipPub10.png)


#### 2) какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
```ipcalc 10.10.0.0/18```
#### Возможны:
#### *10.10.0.2*, 
#### *10.10.10.10*,
#### *10.10.1.255*
#### Не возможны: 
#### *10.0.0.1*, 
#### *10.10.100.1*, 
![ipcalc](/src/imgs/part1/ipW.png)

# Part 2. Статическая маршрутизация между двумя машинами  
#### С помощью команды `ip a` посмотреть существующие сетевые интерфейсы
#### Для машины ws1:
![stat](/src/imgs/part2/ipA1.png)
#### Для машины ws2:
![stat](/src/imgs/part2/ipA2.png)
#### Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - *192.168.100.10*, маска */16*, ws2 - *172.24.116.8*, маска */12*
```sudo vi ../../etc/netplan/00-installer-config.yaml```
![stat](/src/imgs/part2/00-ipAddress.png)
#### Выполнить команду `netplan apply` для перезапуска сервиса сети
```sudo netplan apply```
![stat](/src/imgs/part2/netplanApply.png)

#### 2.1. Добавление статического маршрута вручную
#### Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`
#### ws1 ```sudo ip r add 172.24.116.8 dev enp0s3```
#### ws2 ```sudo ip r add 192.168.100.10 dev enp0s3```
![stat](/src/imgs/part2/iPrAdd.png)
#### Пропинговать соединение между машинами
#### ws1 ```ping -c 4 172.24.116.8```
#### ws2 ```ping -c 4 192.168.100.10```
![stat](/src/imgs/part2/ping.png)
#### 2.2. Добавление статического маршрута с сохранением
#### Перезапустить машины:
```sudo reboot```
#### Добавить статический маршрут от одной машины до другой с помощью файла *etc/netplan/00-installer-config.yaml*
```sudo vi ../../etc/netplan/00-installer-config.yaml```
![stat](/src/imgs/part2/00-routes.png)
#### Пропинговать соединение между машинами
```sudo netplan apply```
#### ws1 ```ping -c 4 172.24.116.8```
#### ws2 ```ping -c 4 192.168.100.10```
![stat](/src/imgs/part2/ping.png)


# Part 3. Утилита **iperf3**
#### В этой задаче вам нужно использовать ws1 и ws2 из части 2.
### Установка iperf3.
```sudo apt install iperf3```
#### Команда завершается с ошибкой, так как нет подключения к интернету.
![iperf3](/src/imgs/part2/instaLLiperf3.png)
#### Испарвляем:
`sudo vi ../../etc/netplan/00-interface-config.yaml` 
![iperf3](/src/imgs/part2/00-dhcpTrue.png)

#### Включаем новый адаптер
![iperf3](/src/imgs/part2/adapterNAT.png)
```sudo netplan apply```
#### Утилита успешно установлена.
`sudo apt install iperf3`
![iperf3](/src/imgs/part2/iperf3successInstall.png)
## 3.1. Скорость соединения
#### 8 Mpbs = 1 MB/s
#### 100 MB/s = 800000 Kbps
#### 1 Gbps = 1000 Mbps

## 3.2. Утилита **iperf3**
#### Измерить скорость соединения между ws1 и ws2
#### w1 `iperf3 -s`
#### w2 `iperf3 -c 192.168.100.10 -p 5201`
![iperf3](/src/imgs/part2/speadConnect.png)
# Part 4. Сетевой экран
#### 4.1. Утилита **iptables**
##### Создать файл */etc/firewall.sh*, имитирующий фаерволл, на ws1 и ws2:
```shell
#!/bin/sh

# Удаление всех правил в таблице "filter" (по-умолчанию).
iptables –F
iptables -X
```
#### Нужно добавить в файл подряд следующие правила:
#### 1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)
#### 2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)
#### 3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)
#### 4) запретить *echo reply* (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)
#### 5) разрешить *echo reply* (машина должна "пинговаться")
### Bводим команды iptable для ws1 и ws2 по инструкции:
![iperf3](/src/imgs/part2/iptable1.png)
#### Запустить файлы на обеих машинах командами 
`chmod +x /etc/firewall.sh`
####
`/etc/firewall.sh`
![iperf3](/src/imgs/part2/iptableRunChmod.png)
#### `ping -c 3 8.8.8.8` - добавить передачу данных.
#### `sudo iptables -L -v -n` - список созданных правил.
![iperf3](/src/imgs/part2/resIPtable.png)
#### Разница между стратегиями - будет выполнено первое подходящее правило. Правила, которые применяются после, будут игнорироваться.

### 4.2. Утилита **nmap**
`sudo apt install nmap`
#### Командой **ping** найти машину, которая не "пингуется", после чего утилитой **nmap** показать, что хост машины запущен
![iperf3](/src/imgs/part2/nmap1.png)
*Проверка: в выводе nmap должно быть сказано: `Host is up`* 
- В отчёт поместить скрины с вызовом и выводом использованных команд **ping** и **nmap**.

#### Сохранить дампы образов виртуальных машин
**p.s. Ни в коем случае не сохранять дампы в гит!**


# Part 5. Статическая маршрутизация сети
Сеть: \
<img src="../misc/images/part5_network.png" alt="part5_network" width="500"/>

#### Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))

## 5.1. Настройка адресов машин
#### Настроить конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке.
![network](/src/imgs/part5/runAllMachins.png)
#### Перезапустить сервис сети. Если ошибок нет, то командой `ip -4 a` проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.
![network](/src/imgs/part5/ipaPing.png)

## 5.2. Включение переадресации IP-адресов.
#### Для включения переадресации IP, выполните команду на роутерах:
`sysctl -w net.ipv4.ip_forward=1`
*При таком подходе переадресация не будет работать после перезагрузки системы.*
![network](/src/imgs/part5/sysctlR1R2.png)
#### Откройте файл */etc/sysctl.conf* и добавьте в него следующую строку:
`net.ipv4.ip_forward = 1`
*При использовании этого подхода, IP-переадресация включена на постоянной основе.*
![network](/src/imgs/part5/sysctlConf.png)

## 5.3. Установка маршрута по-умолчанию
#### Пример вывода команды `ip r` после добавления шлюза:
![network](/src/imgs/part5/ipRws11.png)
#### Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить `default` перед IP роутера в файле конфигураций

![network](/src/imgs/part5/5.3.1.png)
#### Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации
![network](/src/imgs/part5/ipR.png)
#### Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:
`tcpdump -tn -i eth1`
![network](/src/imgs/part5/5.3Ping.png)

## 5.4. Добавление статических маршрутов
#### Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций. 

![network](/src/imgs/part5/5.4.1R1R2.png)
#### Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах. 

![network](/src/imgs/part5/5.4.2ipR.png)
#### Запустить команды на ws11:
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`

![network](/src/imgs/part5/5.4.3ipList.png)
- Первый IP-адрес и маска соответствуют маршруту, установленному в сетевом плане (10.10.0.0 /18), а другой нет (одна из вещей, которая не подходит под правило - 0.0.0.0/0 находится вне установленной маски), поэтому он следует маршруту, установленному по умолчанию.

## 5.5. Построение списка маршрутизаторов
#### Запустить на r1 команду дампа:
`tcpdump -tnv -i eth0`
#### При помощи утилиты **traceroute** построить список маршрутизаторов на пути от ws11 до ws21
![network](/src/imgs/part5/5.5traceroute.png)
- В отчёте, опираясь на вывод, полученный из дампа на r1, объяснить принцип работы построения пути при помощи **traceroute**.
#### Cначала данные идут на интерфейс eth0 маршрутизатора r1, затем они маршрутизируются на второй маршрутизатор с использованием интерфейса eth0 маршрутизатора r2 и, наконец, перенаправляется к месту назначения 10.20.0.10.

## 5.6. Использование протокола **ICMP** при маршрутизации
#### Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
`tcpdump -n -i eth0 icmp`
#### Пропинговать с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды:
`ping -c 1 10.30.0.111`
![network](/src/imgs/part5/5.6icmp.png)

# Part 6. Динамическая настройка IP с помощью **DHCP**

#### Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:
`sudo apt install isc-dhcp-server`
#### 1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети. Пример файла для r2:
![part6](/src/imgs/part6/6.1dhcpdConf.png)
#### 2) в файле *resolv.conf* прописать `nameserver 8.8.8.8.`
![part6](/src/imgs/part6/6.2resolvConf.png)
#### Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`. 
![part6](/src/imgs/part6/6.3RestartR2.png)


#### Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.
`sudo reboot`
### 
`ip a`
![part6](/src/imgs/part6/6.4ipRpingWS21.png)

#### Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`
![part6](/src/imgs/part6/6.5macAddress.png)
#### Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты
![part6](/src/imgs/part6/6.6r1DHCPconf.png)
![part6](/src/imgs/part6/6.7RestartR1.png)
#### Запросить с ws21 обновление ip адреса
#### ip до и после обновления.
![part6](/src/imgs/part6/6.8UpdateIPws21.png)
- В отчёте описать, какими опциями **DHCP** сервера пользовались в данном пункте.

#### dhclient -r для сброса текущего адреса

# Part 7. **NAT**
#### В файле */etc/apache2/ports.conf* на ws22 и r1 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным
![part7](/src/imgs/part7/7.1apachePort.png)
#### Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1
![part6](/src/imgs/part7/7.2startApache.png)
#### Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
#### 1) Удаление правил в таблице filter - `iptables -F`
#### 2) Удаление правил в таблице "NAT" - `iptables -F -t nat`
#### 3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`
![part6](/src/imgs/part7/7.3firewal.png)
#### Запускать файл также, как в Части 4
![part6](/src/imgs/part7/7.4shRun.png)
#### Проверить соединение между ws22 и r1 командой `ping`
*При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1*
![part6](/src/imgs/part7/7.5pingLoss.png)
#### Добавить в файл ещё одно правило:
#### 4) Разрешить маршрутизацию всех пакетов протокола **ICMP**
#### Запускать файл также, как в Части 4
![part6](/src/imgs/part7/7.6AcceptICMP.png)
#### Проверить соединение между ws22 и r1 командой `ping`
*При запуске файла с этими правилами, ws22 должна "пинговаться" с r1*
![part6](/src/imgs/part7/7.7pingOk.png)
#### Добавить в файл ещё два правила:
#### 5) Включить **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
![part6](/src/imgs/part7/7.8snat.png)
#### 6) Включить **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
![part6](/src/imgs/part7/7.9dnat.png)

#### Проверить соединение по TCP для **SNAT**, для этого с ws22 подключиться к серверу Apache на r1 командой:
`telnet [адрес] [порт]`
![part6](/src/imgs/part7/7.10ws22.png)
#### Проверить соединение по TCP для **DNAT**, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080)
![part6](/src/imgs/part7/7.11R1.png)
#
# Part 8. Дополнительно. Знакомство с **SSH Tunnels**
#

#### Запустить на r2 фаервол с правилами из Части 7
![part6](/src/imgs/part8/8.1startFirewal.png)
#### Запустить веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* изменить строку `Listen 80` на `Listen localhost:80`)
![part6](/src/imgs/part8/8.2localhost.png)
#### `service apache2 start`
#### `service apache2 status`
![part6](/src/imgs/part8/8.3StartStatus.png)
#### Воспользоваться *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21
![part6](/src/imgs/part8/8.4LocalTCP.png)
#### Воспользоваться *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11
![part6](/src/imgs/part8/8.5RemouteTCP.png)
#### Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:
`telnet 127.0.0.1 [локальный порт]`
![part6](/src/imgs/part8/8.6Ceck.jpg)
